{% extends "base.html" %}
{% block title %}Мастер: мои заявки{% endblock %}
{% block content %}
<h1 class="h5 mb-3">Мои активные заявки</h1>

<div class="d-lg-none">
  <!-- мобильный вид карточками -->
  {% for o in orders %}
    <div class="card shadow-sm mb-2" id="order_{{ o.id }}">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div><b>#{{ o.id }}</b> — {{ o.get_status_display }}</div>
          <a href="{% url 'master_order_detail' o.id %}" class="btn btn-outline-primary btn-sm">Открыть</a>
        </div>
        <div class="text-muted small mt-1">{{ o.address }}</div>
        <div class="mt-2">{{ o.description|truncatechars:110 }}</div>

        <div class="d-flex gap-2 mt-3">
          <button class="btn btn-warning btn-sm" onclick="startOrder({{ o.id }})">Начать</button>
          <button class="btn btn-success btn-sm" onclick="completeOrder({{ o.id }})">Завершить</button>
        </div>
      </div>
    </div>
  {% empty %}
    <div class="text-muted">Нет активных заявок.</div>
  {% endfor %}
</div>

<div class="d-none d-lg-block">
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead>
          <tr>
            <th>ID</th>
            <th>Дата</th>
            <th>Адрес</th>
            <th>Описание</th>
            <th>Статус</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          {% for o in orders %}
            <tr id="order_{{ o.id }}">
              <td><a href="{% url 'master_order_detail' o.id %}">#{{ o.id }}</a></td>
              <td>{{ o.created_at|date:"d.m.Y H:i" }}</td>
              <td>{{ o.address }}</td>
              <td>{{ o.description|truncatechars:70 }}</td>
              <td>{{ o.get_status_display }}</td>
              <td class="text-end">
                <button class="btn btn-warning btn-sm" onclick="startOrder({{ o.id }})">Начать</button>
                <button class="btn btn-success btn-sm" onclick="completeOrder({{ o.id }})">Завершить</button>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="6" class="text-muted">Нет активных заявок.</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
function startOrder(orderId) {
  $.post("/master/order/" + orderId + "/start/", {"csrfmiddlewaretoken": "{{ csrf_token }}"})
   .done(function(){ location.reload(); })
   .fail(function(xhr){ alert(xhr.responseJSON?.error || "Ошибка"); });
}

function completeOrder(orderId) {
  $.post("/master/order/" + orderId + "/complete/", {"csrfmiddlewaretoken": "{{ csrf_token }}"})
   .done(function(){
     $("#order_" + orderId).fadeOut();
   })
   .fail(function(xhr){ alert(xhr.responseJSON?.error || "Ошибка"); });
}
</script>
{% endblock %}

